rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() { return request.auth != null; }
    function isOwner(userId) { return isAuthenticated() && request.auth.uid == userId; }
    
    // [기존] 본인 가입 신청 허용 규칙
    function isSelfJoinRequest() {
       return isAuthenticated() 
              && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['joinRequests']);
    }

    // [New] 용병 신청 규칙 (신청자 목록 applicants 필드만 변경하는 경우 허용)
    function isGuestApplication() {
       return isAuthenticated() 
              && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['applicants']);
    }

    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(userId);
    }

    match /teams/{teamId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // 대표자는 모든 수정 가능 OR 일반 유저는 가입 신청만 가능
      allow update: if isAuthenticated() && (resource.data.captainId == request.auth.uid || isSelfJoinRequest());
      allow delete: if isAuthenticated() && resource.data.captainId == request.auth.uid;
    }

    match /matches/{matchId} {
      allow read, create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.status != 'finished'; 
      allow delete: if isAuthenticated() && resource.data.hostId == request.auth.uid;
    }
    
    // [New] 용병 모집 게시판 규칙 (새로 추가됨)
    match /guest_posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // 로그인한 누구나 작성 가능
      // 작성자 본인 수정 가능 OR 다른 사람은 신청(applicants 수정)만 가능
      allow update: if isAuthenticated() && (resource.data.hostCaptainId == request.auth.uid || isGuestApplication());
      allow delete: if isAuthenticated() && resource.data.hostCaptainId == request.auth.uid;
    }
    
    match /notifications/{id} { allow read, write: if isAuthenticated(); }
    match /inquiries/{id} { allow read, write: if isAuthenticated(); }
  }
}