rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() { return request.auth != null; }
    function isOwner(userId) { return isAuthenticated() && request.auth.uid == userId; }
    
    // [New] 본인이 가입 신청(joinRequests 배열 추가)을 하는지 확인
    // request.resource.data.joinRequests가 기존 resource.data.joinRequests에 본인 데이터를 추가한 형태인지 검증해야 완벽하지만,
    // MVP 단계에서는 'joinRequests' 필드만 변경하는 경우 허용하는 것으로 간단화.
    function isSelfJoinRequest() {
       return isAuthenticated() 
              && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['joinRequests']);
    }

    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(userId);
    }

    match /teams/{teamId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // 대표자는 모든 수정 가능 OR 일반 유저는 가입 신청만 가능
      allow update: if isAuthenticated() && (resource.data.captainId == request.auth.uid || isSelfJoinRequest());
      allow delete: if isAuthenticated() && resource.data.captainId == request.auth.uid;
    }

    // ... (Matches, Notifications 등 기존 규칙 동일) ...
    match /matches/{matchId} {
      allow read, create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.status != 'finished'; 
      allow delete: if isAuthenticated() && resource.data.hostId == request.auth.uid; // 간소화
    }
    
    match /notifications/{id} { allow read, write: if isAuthenticated(); }
    match /inquiries/{id} { allow read, write: if isAuthenticated(); }
  }
}